#Область ПрограммныйИнтерфейс

// Открыть форму настройки отборов.
// 
// Параметры:
//  ПараметрыОткрытия - Структура:
//  * НеНастраиватьПараметры - Булево
//  * УникальныйИдентификатор - УникальныйИдентификатор
//  * СхемаКомпоновкиДанных - СхемаКомпоновкиДанных
//  * НастройкиКомпоновкиДанных - НастройкиКомпоновкиДанных
//  Форма - ФормаКлиентскогоПриложения
//  ЗаголовокФормы - Строка.
Процедура ОткрытьФормуНастройкиОтборов(ПараметрыОткрытия, Форма, ЗаголовокФормы = "") Экспорт

	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("НеПомещатьНастройкиВСхемуКомпоновкиДанных", Истина);
	ПараметрыФормы.Вставить("НеЗагружатьСхемуКомпоновкиДанныхИзФайла", Истина);
	ПараметрыФормы.Вставить("НеНастраиватьПараметры", ПараметрыОткрытия.НеНастраиватьПараметры);
	ПараметрыФормы.Вставить("НеРедактироватьСхемуКомпоновкиДанных", Истина);
	ПараметрыФормы.Вставить("НеНастраиватьУсловноеОформление", Истина);
	ПараметрыФормы.Вставить("НеНастраиватьВыбор", Истина);
	ПараметрыФормы.Вставить("НеНастраиватьПорядок", Истина);
	ПараметрыФормы.Вставить("УникальныйИдентификатор", ПараметрыОткрытия.УникальныйИдентификатор);
	ПараметрыФормы.Вставить("АдресСхемыКомпоновкиДанных", ПараметрыОткрытия.СхемаКомпоновкиДанных);
	ПараметрыФормы.Вставить("АдресНастроекКомпоновкиДанных", ПараметрыОткрытия.НастройкиКомпоновкиДанных);
	ПараметрыФормы.Вставить("Заголовок", ЗаголовокФормы);
	
	ОткрытьФорму("ОбщаяФорма.УпрощеннаяНастройкаСхемыКомпоновкиДанных",
		ПараметрыФормы,,,,,
		Новый ОписаниеОповещения("РедактироватьСхемуКомпоновкиДанныхЗавершение",
			Форма,
			ПараметрыОткрытия),
		РежимОткрытияОкнаФормы.БлокироватьВесьИнтерфейс);

КонецПроцедуры

// Формирует правила заполнения настраиваемой отчестности.
// 
// Параметры:
//  Настройка - СправочникСсылка.НастройкиЗаполненияБухОтчетности - Настройка
//  Форма - ФормаКлиентскогоПриложения
//  ИмяКоманды - Строка - Нименование вызывающей команды
Процедура СгенерироватьНастройкиПоУмолчанию(Настройка, Форма, ИмяКоманды) Экспорт
	
	ИДФормыОтчета = Прав(ИмяКоманды, СтрДлина(ИмяКоманды) - СтрНайти(ИмяКоманды, "ФормаОтчета") + 1);
	
	ФормыОтчетностиКЗагрузке = НастраиваемаяБухгалтерскаяОтчетностьВызовСервера.СоставФормБухотчетности(ИДФормыОтчета);
	
	ЗагрузитьНастройкиФормыОтчетности(Форма, Настройка, ФормыОтчетностиКЗагрузке, ИДФормыОтчета);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Асинх Процедура ЗагрузитьНастройкиФормыОтчетности(Форма, Настройка, ФормыОтчетностиКЗагрузке, ИДФормыОтчета)
	
	ВыбратьФормы = ФормыОтчетностиКЗагрузке.ОтметитьЭлементыАсинх("Выберите формы к загрузке");
	
	ВыбранныеФормы = Ждать ВыбратьФормы;
		
	Если ВыбранныеФормы <> Неопределено Тогда
		
		ФормыКзагрузке = Новый Массив;
		Для Каждого ФормаОтчетности Из ВыбранныеФормы Цикл
			Если ФормаОтчетности.Пометка Тогда
				ФормыКзагрузке.Добавить(ФормаОтчетности.Значение);
			КонецЕсли;
		КонецЦикла;
		
		ТекущиеЭлементыНастройки = НастраиваемаяБухгалтерскаяОтчетностьВызовСервера.ТекущиеЭлементыНастройки(Настройка, ФормыКзагрузке);
		Если ТекущиеЭлементыНастройки.Количество()>0 Тогда
			Режим = РежимДиалогаВопрос.ДаНет;
			Ответ = Ждать ВопросАсинх(НСтр("ru = 'Обнаружены существующие настройки по указанным формам. Они будут помечены на удаление и созданы новые.
													|Продолжить?'"), Режим, 0);
			Если Ответ = КодВозвратаДиалога.Нет Тогда
				Возврат;
			КонецЕсли;
		КонецЕсли;
		
		ДлительнаяОперация = НастраиваемаяБухгалтерскаяОтчетностьВызовСервера.СгенерироватьНастройкиПоУмолчанию(
			Настройка,
			ФормыКзагрузке,
			ТекущиеЭлементыНастройки,
			ИДФормыОтчета);
		ОповещениеОЗавершении = Новый ОписаниеОповещения("СгенерироватьНастройкиПоУмолчаниюЗавершение", НастраиваемаяБухгалтерскаяОтчетностьКлиент);
		ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(Форма);
		ПараметрыОжидания.ВыводитьОкноОжидания = Истина;
		ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация, ОповещениеОЗавершении, ПараметрыОжидания);

	КонецЕсли;
	
КонецПроцедуры

Процедура СгенерироватьНастройкиПоУмолчаниюЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ОбщегоНазначенияКлиент.СообщитьПользователю(НСтр("ru = 'Формирование настроек заполнения бухгалтерской отчетности завершено.'"));
	
	Оповестить("ГенерацияПравилНастраиваемойОтчетности");

КонецПроцедуры

#КонецОбласти
