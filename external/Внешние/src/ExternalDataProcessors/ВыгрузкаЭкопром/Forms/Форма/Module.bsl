#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	СформироватьЗаголовокФормы(); 
	ЗагрузитьНастройки();
КонецПроцедуры

&НаСервере
Процедура ОбработкаПроверкиЗаполненияНаСервере(Отказ, ПроверяемыеРеквизиты)
	
	Для Каждого Строка_epsales Из Объект.epsales Цикл
		Если ЭтоПродажа(Строка_epsales.opcode) И Строка_epsales.amount_cp = 0 Тогда
			ПутьКДанным = СтрШаблон("Объект.epsales[%1].amount_cp", Формат(Строка_epsales.НомерСтроки - 1, "ЧН=0; ЧГ=;"));
			ОбщегоНазначения.СообщитьПользователю("Не заполнена сумма покупки/продажи",,, ПутьКДанным, Отказ);
		ИначеЕсли Не ЭтоПродажа(Строка_epsales.opcode) И Строка_epsales.amount_bp = 0 Тогда
			ПутьКДанным = СтрШаблон("Объект.epsales[%1].amount_bp", Формат(Строка_epsales.НомерСтроки - 1, "ЧН=0; ЧГ=;"));
			ОбщегоНазначения.СообщитьПользователю("Не заполнена сумма покупки/продажи",,, ПутьКДанным, Отказ);
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого СтрокаОстатки Из Объект.eprest Цикл
    	Если СтрокаОстатки.beg_rest = 0 И СтрокаОстатки.beg_amount <> 0 Тогда
			ПутьКДанным = СтрШаблон("Объект.eprest[%1].beg_amount", Формат(СтрокаОстатки.НомерСтроки - 1, "ЧН=0; ЧГ=;"));
			ОбщегоНазначения.СообщитьПользователю("Не заполнена сумма остатка на начало количества при не нулевой сумме",,, ПутьКДанным, Отказ);
    	КонецЕсли;
    	Если СтрокаОстатки.end_rest = 0 И СтрокаОстатки.end_amount <> 0 Тогда
			ПутьКДанным = СтрШаблон("Объект.eprest[%1].end_amount", Формат(СтрокаОстатки.НомерСтроки - 1, "ЧН=0; ЧГ=;"));
			ОбщегоНазначения.СообщитьПользователю("Не заполнена сумма остатка на конец количества при не нулевой сумме",,, ПутьКДанным, Отказ);
    	КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ДатаНачалаПриИзменении(Элемент)
	
	Если ЗначениеЗаполнено(Объект.ДатаНачала) Тогда
		Объект.ДатаОкончания = КонецДня(Объект.ДатаНачала + Объект.ГлубинаОтчетаДней * 86400);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПутьВыгрузкиНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	
	ИмяРеквизита = "ПутьВыгрузки";
	ОписаниеОповещения = Новый ОписаниеОповещения("ВыборФайлаКаталогаЗавершение", ЭтотОбъект, ИмяРеквизита);
	
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога);
	Диалог.Показать(ОписаниеОповещения);
КонецПроцедуры

&НаКлиенте
Процедура ПутьКлиентаCisLinkНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	
	ИмяРеквизита = "ПутьКлиентаCisLink";
	ОписаниеОповещения = Новый ОписаниеОповещения("ВыборФайлаКаталогаЗавершение", ЭтотОбъект, ИмяРеквизита);
	
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.Фильтр = "*.exe|*.exe";
	Диалог.Показать(ОписаниеОповещения);
КонецПроцедуры

&НаКлиенте
Процедура ИсходящаяПапкаCisLinkНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	
	ИмяРеквизита = "ИсходящаяПапкаCisLink";
	ОписаниеОповещения = Новый ОписаниеОповещения("ВыборФайлаКаталогаЗавершение", ЭтотОбъект, ИмяРеквизита);
	
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога);
	Диалог.Показать(ОписаниеОповещения);
КонецПроцедуры

&НаКлиенте
Процедура ВходящаяПапкаCisLinkНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	
	ИмяРеквизита = "ВходящаяПапкаCisLink";
	ОписаниеОповещения = Новый ОписаниеОповещения("ВыборФайлаКаталогаЗавершение", ЭтотОбъект, ИмяРеквизита);
	
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога);
	Диалог.Показать(ОписаниеОповещения);
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ЗаписатьНастройки(Команда)
	ЗаписатьНастройкиНаСервере()
КонецПроцедуры

&НаКлиенте
Процедура Заполнить(Команда)
	ЗаполнитьНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура Выгрузить(Команда)
	
	Если Не ПроверитьЗаполнение() Тогда
		Возврат;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Объект.ПутьВыгрузки) Тогда
		ОбщегоНазначенияКлиент.СообщитьПользователю("Не указан путь выгрузки",,, "Объект.ПутьВыгрузки");
		Возврат;
	КонецЕсли;
	
	АдресРезультатаВыгрузки = ЗаписатьНаСервере();
	ДанныеФайлов = ПолучитьИзВременногоХранилища(АдресРезультатаВыгрузки);
	Для Каждого ИмяДанныеФайла Из ДанныеФайлов Цикл
		ПолноеИмяФайла = СтрШаблон("%1\%2", Объект.ПутьВыгрузки, ИмяДанныеФайла.ИмяФайла);
		ИмяДанныеФайла.ДанныеФайла.Записать(ПолноеИмяФайла);
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура Отправить(Команда)
	
	Если Не ЗначениеЗаполнено(Объект.ИсходящаяПапкаCisLink) Тогда
		ОбщегоНазначенияКлиент.СообщитьПользователю("Не выбран клиент CISLINK",,, "Объект.ИсходящаяПапкаCisLink");
		Возврат;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(АдресРезультатаВыгрузки) Или Не ЭтоАдресВременногоХранилища(АдресРезультатаВыгрузки) Тогда
		ОбщегоНазначенияКлиент.СообщитьПользователю("Данные необходимо выгрузить перед отправкой");
		Возврат;
	КонецЕсли;
	
	ОтправитьНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьЧерезCISLink(Команда)
	
	Если Не ЗначениеЗаполнено(Объект.ПутьКлиентаCisLink) Тогда
		ОбщегоНазначенияКлиент.СообщитьПользователю("Не выбран клиент CISLINK",,, "Объект.ПутьКлиентаCisLink");
		Возврат;
	КонецЕсли;
	
	ОтправитьЧерезCISLinkНаСервере();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область Диалог

&НаСервере
Процедура СформироватьЗаголовокФормы()
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	СведенияОбработки = ОбработкаОбъект.СведенияОВнешнейОбработке();
	Заголовок = СтрШаблон("%1 v <%2>", СведенияОбработки.Наименование, СведенияОбработки.Версия);
КонецПроцедуры

&НаКлиенте
Процедура ВыборФайлаКаталогаЗавершение(ВыбранныеИменаФайлов, ИмяРеквизита) Экспорт
	
	Если Не ЗначениеЗаполнено(ВыбранныеИменаФайлов) Тогда
		Возврат;
	КонецЕсли;
	
	Объект[ИмяРеквизита] = ВыбранныеИменаФайлов[0];
	
КонецПроцедуры

#КонецОбласти

#Область Сервис

&НаСервере
Процедура ЗагрузитьНастройки()
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	ОбработкаОбъект.ЗагрузитьНастройки();
	ЗначениеВРеквизитФормы(ОбработкаОбъект, "Объект");
КонецПроцедуры

&НаСервере
Процедура ЗаписатьНастройкиНаСервере()
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	ОбработкаОбъект.ЗаписатьНастройки();
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНаСервере()
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	ОбработкаОбъект.Заполнить();
	ЗначениеВРеквизитФормы(ОбработкаОбъект, "Объект");
КонецПроцедуры

&НаСервере
Функция ЗаписатьНаСервере()
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	АдресРезультата = ОбработкаОбъект.ЗаписатьДанные(УникальныйИдентификатор);
	Возврат АдресРезультата;
КонецФункции

&НаСервере
Процедура ОтправитьНаСервере()
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	ОбработкаОбъект.ПодготовитьФайлыКОтправке(АдресРезультатаВыгрузки, Истина);
КонецПроцедуры

&НаСервере
Процедура ОтправитьЧерезCISLinkНаСервере()
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	ОбработкаОбъект.ЗапуститьCISLink(Истина);
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция ЭтоПродажа(ТипОперации)
	Возврат ТипОперации = 0 Или ТипОперации = 1 Или ТипОперации = 7;
КонецФункции

#КонецОбласти

#КонецОбласти